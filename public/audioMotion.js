!function(e){var t={};function a(n){if(t[n])return t[n].exports;var o=t[n]={i:n,l:!1,exports:{}};return e[n].call(o.exports,o,o.exports,a),o.l=!0,o.exports}a.m=e,a.c=t,a.d=function(e,t,n){a.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},a.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},a.t=function(e,t){if(1&t&&(e=a(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var n=Object.create(null);if(a.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var o in e)a.d(n,o,function(t){return e[t]}.bind(null,o));return n},a.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return a.d(t,"a",t),t},a.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},a.p="",a(a.s=3)}([function(e,t,a){a(1)(a(2))},function(e,t){e.exports=function(e){function t(e){"undefined"!=typeof console&&(console.error||console.log)("[Script Loader]",e)}try{"undefined"!=typeof execScript&&"undefined"!=typeof attachEvent&&"undefined"==typeof addEventListener?execScript(e):"undefined"!=typeof eval?eval.call(null,e):t("EvalError: No eval function available")}catch(e){t(e)}}},function(e,t){e.exports='/**\r\n * localStorage polyfill\r\n * https://developer.mozilla.org/en-US/docs/Web/API/Web_Storage_API/Local_storage\r\n */\r\nif (!window.localStorage) {\r\n\tObject.defineProperty(window, "localStorage", new (function () {\r\n\t\tvar aKeys = [], oStorage = {};\r\n\t\tObject.defineProperty(oStorage, "getItem", {\r\n\t\t\tvalue: function (sKey) { return this[sKey] ? this[sKey] : null; },\r\n\t\t\twritable: false,\r\n\t\t\tconfigurable: false,\r\n\t\t\tenumerable: false\r\n\t\t});\r\n\t\tObject.defineProperty(oStorage, "key", {\r\n\t\t\tvalue: function (nKeyId) { return aKeys[nKeyId]; },\r\n\t\t\twritable: false,\r\n\t\t\tconfigurable: false,\r\n\t\t\tenumerable: false\r\n\t\t});\r\n\t\tObject.defineProperty(oStorage, "setItem", {\r\n\t\t\tvalue: function (sKey, sValue) {\r\n\t\t\t\tif(!sKey) { return; }\r\n\t\t\t\tdocument.cookie = escape(sKey) + "=" + escape(sValue) + "; expires=Tue, 31 Dec 2099 23:59:59 GMT; path=/";\r\n\t\t\t},\r\n\t\t\twritable: false,\r\n\t\t\tconfigurable: false,\r\n\t\t\tenumerable: false\r\n\t\t});\r\n\t\tObject.defineProperty(oStorage, "length", {\r\n\t\t\tget: function () { return aKeys.length; },\r\n\t\t\tconfigurable: false,\r\n\t\t\tenumerable: false\r\n\t\t});\r\n\t\tObject.defineProperty(oStorage, "removeItem", {\r\n\t\t\tvalue: function (sKey) {\r\n\t\t\t\tif(!sKey) { return; }\r\n\t\t\t\tdocument.cookie = escape(sKey) + "=; expires=Thu, 01 Jan 1970 00:00:00 GMT; path=/";\r\n\t\t\t},\r\n\t\t\twritable: false,\r\n\t\t\tconfigurable: false,\r\n\t\t\tenumerable: false\r\n\t\t});\r\n\t\tObject.defineProperty(oStorage, "clear", {\r\n\t\t\tvalue: function () {\r\n\t\t\t\tif(!aKeys.length) { return; }\r\n\t\t\t\tfor (var sKey in oStorage) {\r\n\t\t\t\t\tdocument.cookie = escape(sKey) + "=; expires=Thu, 01 Jan 1970 00:00:00 GMT; path=/";\r\n\t\t\t\t}\r\n\t\t\t},\r\n\t\t\twritable: false,\r\n\t\t\tconfigurable: false,\r\n\t\t\tenumerable: false\r\n\t\t});\r\n\t\tthis.get = function () {\r\n\t\t\tvar iThisIndx;\r\n\t\t\tfor (var sKey in oStorage) {\r\n\t\t\t\tiThisIndx = aKeys.indexOf(sKey);\r\n\t\t\t\tif (iThisIndx === -1) { oStorage.setItem(sKey, oStorage[sKey]); }\r\n\t\t\t\telse { aKeys.splice(iThisIndx, 1); }\r\n\t\t\t\tdelete oStorage[sKey];\r\n\t\t\t}\r\n\t\t\tfor (aKeys; aKeys.length > 0; aKeys.splice(0, 1)) { oStorage.removeItem(aKeys[0]); }\r\n\t\t\tfor (var aCouple, iKey, nIdx = 0, aCouples = document.cookie.split(/\\s*;\\s*/); nIdx < aCouples.length; nIdx++) {\r\n\t\t\t\taCouple = aCouples[nIdx].split(/\\s*=\\s*/);\r\n\t\t\t\tif (aCouple.length > 1) {\r\n\t\t\t\t\toStorage[iKey = unescape(aCouple[0])] = unescape(aCouple[1]);\r\n\t\t\t\t\taKeys.push(iKey);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\treturn oStorage;\r\n\t\t};\r\n\t\tthis.configurable = false;\r\n\t\tthis.enumerable = true;\r\n\t})());\r\n}\r\n'},function(e,t,a){"use strict";a.r(t);a(0);var n,o,r,l=[],i=[],s=!1;function c(e,t=!1){var a="";return i.forEach(e=>{a+=e.dir+"/"}),e&&(a+=e),s&&(a=a.replace(/[\\\/]/g,"%2f"),a=t?"/getDir/"+a:"/getFile/"+a),a}function d(e,t){var a,d;void 0!==e&&(":"==e[1]?i=[{dir:e,scrollTop:0}]:".."==e?a=i.pop():i.push({dir:e,scrollTop:o.scrollTop})),d=c("",!0),fetch(d).then(function(e){if(200==e.status)return s?e.json():e.text();r&&(clearTimeout(r),n.innerHTML="Cannot access /music directory. Check the documentation for help.")}).then(function(e){s||(e=function(e){var t,a=[],n=[],o=e.match(/href="[^"]*"[^>]*>[^<]*<\/a>/gi);for(let e of o){let o=e.match(/href="([^"]*)"[^>]*>\s*([^<]*)<\/a>/i);"/"==o[1].substring(o[1].length-1)?o[2].match(/parent directory/i)||("/"==o[2].substring(o[2].length-1)?n.push(o[2].substring(0,o[2].length-1)):n.push(o[2])):o[2].match(/(folder|cover)\.(jpg|jpeg|png|gif|bmp)$/i)?t=o[2]:o[2].match(/\.(mp3|flac|m4a|aac|ogg|wav|m3u|m3u8)$/)&&a.push(o[2])}return{cover:t,dirs:n,files:a}}(e)),function(e,t){n.innerHTML="",o.innerHTML="",i.forEach((e,t)=>{""==e.dir&&(e.dir="root"),n.innerHTML+=`<li data-depth="${i.length-t-1}">${e.dir}</li> / `}),l.forEach(e=>{o.innerHTML+=`<li data-type="drive" data-path="${e}">[ ${e} ]</li>`}),i.length>1&&(o.innerHTML+='<li data-type="dir" data-path="..">[ parent folder ]</li>'),e&&(e.dirs&&e.dirs.forEach(e=>{o.innerHTML+=`<li data-type="dir" data-path="${e}">${e}</li>`}),e.files&&e.files.forEach(e=>{o.innerHTML+=`<li data-type="${null!==e.match(/\.(m3u|m3u8)$/)?"list":"file"}" data-path="${e}">${e}</li>`})),o.scrollTop=t||0}(e,t||a&&a.scrollTop)}).catch(function(e){console.log("Error on getDir ",e)})}function u(e,t){return(n=document.createElement("ul")).className="breadcrumb",e.appendChild(n),(o=document.createElement("ul")).className="filelist",o.id="file_explorer",e.appendChild(o),r=setTimeout(()=>{n.innerHTML="Waiting for server..."},5e3),n.innerHTML="Initializing... please wait...",n.addEventListener("click",function(e){e.target&&"li"==e.target.localName&&function(e){for(var t;e>0;)t=i.pop(),e--;d(void 0,t&&t.scrollTop)}(e.target.dataset.depth)}),o.addEventListener("click",function(e){e.target&&"li"==e.target.localName&&("dir"==e.target.dataset.type||"drive"==e.target.dataset.type?d(e.target.dataset.path):e.target.classList.toggle("selected"))}),new Promise(e=>{fetch("/getDrives").then(function(e){if(200==e.status)return e.json()}).then(function(a){clearTimeout(r),a?(s=!0,d((l=a)[0]),e(0)):(d((l=[t.defaultPath||"/"])[0]),e(1))}).catch(function(t){clearTimeout(r),n.innerHTML="No server found. File navigation is unavailable.",o.style.display="none",e(-1)})})}var f,p,h,g,m,y,v,b,S,E,w,I,k,x,O,L,N,M,C,B,T,K,P,_,F,H,A,R,q,D,z,j,J,G,V,$,U,X,W,Y,Q,Z,ee,te,ae="19.6-dev.1",ne=!1,oe=[16,31,63,125,250,500,1e3,2e3,4e3,8e3,16e3],re={apple:{name:"Apple ][",bgColor:"#111",colorStops:[{stop:.1667,color:"#61bb46"},{stop:.3333,color:"#fdb827"},{stop:.5,color:"#f5821f"},{stop:.6667,color:"#e03a3e"},{stop:.8333,color:"#963d97"},{stop:1,color:"#009ddc"}]},aurora:{name:"Aurora",bgColor:"#0e172a",colorStops:[{stop:.1,color:"hsl( 120, 100%, 50% )"},{stop:1,color:"hsl( 216, 100%, 50% )"}]},borealis:{name:"Borealis",bgColor:"#0d1526",colorStops:[{stop:.1,color:"hsl( 120, 100%, 50% )"},{stop:.5,color:"hsl( 189, 100%, 40% )"},{stop:1,color:"hsl( 290, 60%, 40% )"}]},candy:{name:"Candy",bgColor:"#0d0619",colorStops:[{stop:.1,color:"#ffaf7b"},{stop:.5,color:"#d76d77"},{stop:1,color:"#3a1c71"}]},classic:{name:"Classic",bgColor:"#111",colorStops:[{stop:0,color:"hsl( 0, 100%, 50% )"},{stop:.6,color:"hsl( 60, 100%, 50% )"},{stop:1,color:"hsl( 120, 100%, 50% )"}]},dusk:{name:"Dusk",bgColor:"#0e172a",colorStops:[{stop:.2,color:"hsl( 55, 100%, 50% )"},{stop:1,color:"hsl( 16, 100%, 50% )"}]},miami:{name:"Miami",bgColor:"#110a11",colorStops:[{stop:.024,color:"rgb( 251, 198, 6 )"},{stop:.283,color:"rgb( 224, 82, 95 )"},{stop:.462,color:"rgb( 194, 78, 154 )"},{stop:.794,color:"rgb( 32, 173, 190 )"},{stop:1,color:"rgb( 22, 158, 95 )"}]},orient:{name:"Orient",bgColor:"#100",colorStops:[{stop:.1,color:"#f00"},{stop:1,color:"#600"}]},outrun:{name:"Outrun",bgColor:"#101",colorStops:[{stop:0,color:"rgb( 255, 223, 67 )"},{stop:.182,color:"rgb( 250, 84, 118 )"},{stop:.364,color:"rgb( 198, 59, 243 )"},{stop:.525,color:"rgb( 133, 80, 255 )"},{stop:.688,color:"rgb( 74, 104, 247 )"},{stop:1,color:"rgb( 35, 210, 255 )"}]},pacific:{name:"Pacific Dream",bgColor:"#051319",colorStops:[{stop:.1,color:"#34e89e"},{stop:1,color:"#0f3443"}]},prism:{name:"Prism",bgColor:"#111"},rainbow:{name:"Rainbow",bgColor:"#111"},shahabi:{name:"Shahabi",bgColor:"#060613",colorStops:[{stop:.1,color:"#66ff00"},{stop:1,color:"#a80077"}]},summer:{name:"Summer",bgColor:"#041919",colorStops:[{stop:.1,color:"#fdbb2d"},{stop:1,color:"#22c1c3"}]},sunset:{name:"Sunset",bgColor:"#021119",colorStops:[{stop:.1,color:"#f56217"},{stop:1,color:"#0b486b"}]},tiedye:{name:"Tie Dye",bgColor:"#111",colorStops:[{stop:.038,color:"rgb( 15, 209, 165 )"},{stop:.208,color:"rgb( 15, 157, 209 )"},{stop:.519,color:"rgb( 133, 13, 230 )"},{stop:.731,color:"rgb( 230, 13, 202 )"},{stop:.941,color:"rgb( 242, 180, 107 )"}]}},le={default:{mode:0,fftSize:8192,freqMin:20,freqMax:22e3,smoothing:.5,gradient:"prism",blackBg:0,cycleGrad:1,ledDisplay:0,showScale:1,highSens:0,showPeaks:1,showSong:1,repeat:0,noShadow:1,loRes:0},fullres:{mode:0,fftSize:8192,freqMin:20,freqMax:22e3,smoothing:.5},octave:{mode:4,fftSize:8192,freqMin:30,freqMax:16e3,smoothing:.5},ledbars:{mode:2,fftSize:8192,freqMin:30,freqMax:16e3,smoothing:.5,blackBg:0,ledDisplay:1,showScale:0}};function ie(){"suspended"==G.state&&G.resume(),ne||($[0].play(),$[1].play(),window.removeEventListener("click",ie))}function se(){document.fullscreenElement?document.exitFullscreen():(Q.requestFullscreen?Q.requestFullscreen():Q.webkitRequestFullscreen?Q.webkitRequestFullscreen():Q.mozRequestFullScreen?Q.mozRequestFullScreen():Q.msRequestFullscreen&&Q.msRequestFullscreen(),document.getElementById("btn_fullscreen").blur())}function ce(){"1"==I.dataset.active?(V.minDecibels=-100,V.maxDecibels=-30):(V.minDecibels=-85,V.maxDecibels=-25),De()}function de(){V.smoothingTimeConstant=S.value,He("smoothingTimeConstant is "+V.smoothingTimeConstant),De()}function ue(){V.fftSize=y.value,U=V.frequencyBinCount,X=new Uint8Array(U),He("FFT size is "+V.fftSize+" samples"),De(),me()}function fe(){for(;Number(b.value)<=Number(v.value);)b.selectedIndex++;De(),me()}function pe(){De(),me()}function he(){F="1"==k.dataset.active,De()}function ge(){H="1"==O.dataset.active,De()}function me(){var e,t;if(R=v.value,q=b.value,_="1"==w.dataset.active,D=Math.log10(R),z=Q.width/(Math.log10(q)-D),A=[],"0"==m.value){var a,n=-1;let o=Math.floor(R*V.fftSize/G.sampleRate),r=Math.round(q*V.fftSize/G.sampleRate);for(j=1,e=o;e<=r;e++)t=e*G.sampleRate/V.fftSize,(a=Math.round(z*(Math.log10(t)-D)))>n?(A.push({posX:a,dataIdx:e,endIdx:0,average:!1,peak:0,hold:0,accel:0}),n=a):A.length&&(A[A.length-1].endIdx=e)}else{switch(m.value){case"24":J={nLeds:24,spaceV:16,spaceH:24};break;case"12":J={nLeds:48,spaceV:8,spaceH:16};break;case"8":J={nLeds:64,spaceV:6,spaceH:10};break;case"4":J={nLeds:80,spaceV:6,spaceH:8};break;case"2":J={nLeds:128,spaceV:4,spaceH:4};break;default:J={nLeds:128,spaceV:3,spaceH:4}}J.spaceH*=ee,J.spaceV*=ee,J.ledHeight=Q.height/J.nLeds-J.spaceV;var o=[],r=0;for(e=0;(t=16.351597831287403*(2**(1/24))**e)<=q;)t>=R&&e%m.value==0&&o.push(t),e++;j=Math.floor(Q.width/o.length)-1;var l=Math.round(Q.width-j*o.length)/(o.length-1);o.forEach(function(e,t){var a,n,i=Math.round(e*V.fftSize/G.sampleRate),s=!1;a=r>0&&r+1<=i?r+1:i,r=n=i,void 0!==o[t+1]&&((n=Math.round(o[t+1]*V.fftSize/G.sampleRate))-i>1?r+=Math.round((n-i)/2):n-i==1&&A.length>0&&a==A[A.length-1].dataIdx&&(s=!0,r+=Math.round((n-i)/2))),A.push({posX:t*(j+l),dataIdx:a,endIdx:r-a>0?r:0,average:s,peak:0,hold:0,accel:0})})}ye()}function ye(){Z.fillStyle="#000",Z.fillRect(0,Q.height-20*ee,Q.width,20*ee),_&&(Z.fillStyle="#fff",Z.font=10*ee+"px sans-serif",Z.textAlign="center",oe.forEach(function(e){var t=z*(Math.log10(e)-D);Z.fillText(e>=1e3?e/1e3+"k":e,t,Q.height-5*ee)}))}function ve(){for(;f.hasChildNodes();)f.removeChild(f.firstChild);Ke()?p=-1:(p=0,$[0].src="",$[1].src=""),Ie()}function be(e){for(var t,a,n=0,o=localStorage.getItem("playlists");x.hasChildNodes();)x.removeChild(x.firstChild);(a=new Option("Select a playlist to load, update or delete","")).disabled=!0,a.selected=!0,x.options[x.options.length]=a,o&&(o=JSON.parse(o),Object.keys(o).forEach(t=>{(a=new Option(o[t],t)).dataset.isLocal="1",t==e&&(a.selected=!0),x.options[x.options.length]=a})),fetch("playlists.cfg").then(function(e){if(200==e.status)return e.text();He("No playlists.cfg file found",!0)}).then(function(e){t=e.split(/[\r\n]+/);for(var o=0;o<t.length;o++)"#"!=t[o].charAt(0)&&""!=t[o].trim()&&2==(a=t[o].split(/\|/)).length&&(x.options[x.options.length]=new Option(a[0].trim(),a[1].trim()),n++);n?He(n+" playlists found in playlists.cfg"):He("No playlists found in playlists.cfg",!0)}).catch(function(e){He("Could not read from playlists.cfg",!0)})}function Se(e){var t=e.common.title||e.file.substring(e.file.lastIndexOf("/")+1),a=document.createElement("li");a.innerHTML=t,a.dataset.artist=e.common.artist||"",a.dataset.title=t,a.dataset.codec=e.format?e.format.codec||e.format.container:e.file.substring(e.file.lastIndexOf(".")+1),a.dataset.file=e.file.replace(/#/g,"%23"),f.appendChild(a)}function Ee(e){var t,a,n,o,r=0;e&&("m3u"==(a=e.substring(e.lastIndexOf(".")+1).toLowerCase())||"m3u8"==a?fetch(e).then(function(e){if(200==e.status)return e.text();He("Fetch returned error code "+e.status,!0)}).then(function(a){t=a.split(/[\r\n]+/),e=e.substring(0,e.lastIndexOf("/")+1);for(var l=0;l<t.length;l++)"#"!=t[l].charAt(0)&&""!=t[l].trim()?(r++,n||(n=(n=t[l].substring(Math.max(t[l].lastIndexOf("/"),t[l].lastIndexOf("\\"))+1)).substring(0,n.lastIndexOf(".")).replace(/_/g," ")),"http"!=t[l].substring(0,4)&&(t[l]=e+t[l]),Se(-1==(o=n.indexOf(" - "))?{file:t[l],common:{artist:"",title:n}}:{file:t[l],common:{artist:n.substring(0,o),title:n.substring(o+3)}}),n=""):"#EXTINF"==t[l].substring(0,7)&&(n=t[l].substring(t[l].indexOf(",")+1||8));He("Loaded "+r+" files into the playlist"),Ke()?Le():Oe(0)}).catch(function(e){He(e,!0)}):(t=localStorage.getItem("pl_"+e))?(t=JSON.parse(t)).forEach(e=>{n=e.substring(Math.max(e.lastIndexOf("/"),e.lastIndexOf("\\"))+1),Se({file:e,common:{artist:"",title:n=n.substring(0,n.lastIndexOf(".")).replace(/_/g," ")}})}):He("Unrecognized playlist file - "+e,!0))}function we(e){var t=!1;if(e?t=!0:e=prompt("Save current playlist as:"),e){var a=e;if(!t){a=(a=a.normalize("NFD").replace(/[\u0300-\u036f]/g,"")).toLowerCase().replace(/[^a-z0-9]/g,"_");var n=localStorage.getItem("playlists");for(n=n?JSON.parse(n):{};!t&&n.hasOwnProperty(a);)a+="_1";n[a]=e,localStorage.setItem("playlists",JSON.stringify(n)),be(a)}var o=[];f.childNodes.forEach(e=>o.push(e.dataset.file)),localStorage.setItem("pl_"+a,JSON.stringify(o))}}function Ie(){var e=f.querySelector(".current");e&&(e.className=""),p<f.children.length&&(f.children[p].className="current")}function ke(){for(var e,t,a=f.children.length-1;a>0;a--)t=Math.floor(Math.random()*(a+1)),e=f.replaceChild(f.children[t],f.children[a]),f.insertBefore(e,f.children[t]);Ne(0),Ie()}function xe(e){if(e){for(var t=0;e=e.previousElementSibling;)t++;return t}}function Oe(e){return!!f.children[e]&&(p=e,$[h].src=f.children[p].dataset.file,$[h].dataset.artist=f.children[p].dataset.artist,$[h].dataset.title=f.children[p].dataset.title,$[h].dataset.codec=f.children[p].dataset.codec,Ie(),Le(),!0)}function Le(){var e;$[g].pause(),e=p<f.children.length-1?p+1:0,$[g].src=f.children[e].dataset.file,$[g].dataset.artist=f.children[e].dataset.artist,$[g].dataset.title=f.children[e].dataset.title,$[g].dataset.codec=f.children[e].dataset.codec}function Ne(e){"mic"!=P&&Oe(e)&&$[h].play()}function Me(){"mic"!=P&&(Ke()?$[h].pause():$[h].play())}function Ce(){"mic"!=P&&($[h].pause(),_e(),Oe(0))}function Be(){"mic"!=P&&(Ke()?Ne(p-1):Oe(p-1))}function Te(e){if(!("mic"==P||p>f.children.length-1)){var t;if(p<f.children.length-1)p++;else{if("1"!=M.dataset.active)return;p=0}e=e||Ke(),$[g=0|!(h=0|!h)].style.display="none",$[h].style.display="block",e?($[h].play().then(Le).catch(function(e){He(e,!0),Le()}),"1"==L.dataset.active&&((t=E.selectedIndex)<E.options.length-1?t++:t=0,E.selectedIndex=t)):Le(),Ie()}}function Ke(){return $[h]&&$[h].currentTime>0&&!$[h].paused&&!$[h].ended}function Pe(e,t,a,n){"1"==T.dataset.active?(Z.strokeText(e,t,a,n),Z.fillText(e,t,a,n)):(Z.shadowOffsetX=Z.shadowOffsetY=3*ee,Z.fillText(e,t,a,n),Z.shadowOffsetX=Z.shadowOffsetY=0)}function _e(e,t=120,a=60){te=e?{msg:e,timer:t,fade:a}:{timer:0}}function Fe(){var e,t,a,n,o,r,l,i,s,c,d,u,g,y,v=E.value,b="1"==N.dataset.active&&"0"!=m.value;for(Z.fillStyle=H?"#000":b?"#111":re[v].bgColor,Z.fillRect(0,0,Q.width,Q.height),V.getByteFrequencyData(X),a=A.length,e=0;e<a;e++){if(0==(n=A[e]).endIdx)o=X[n.dataIdx]/255*Q.height;else if(o=0,n.average){for(t=n.dataIdx;t<=n.endIdx;t++)o+=X[t];o=o/(n.endIdx-n.dataIdx+1)/255*Q.height}else{for(t=n.dataIdx;t<=n.endIdx;t++)o=Math.max(o,X[t]);o=o/255*Q.height}b&&(o=Math.floor(o/Q.height*J.nLeds)*(J.ledHeight+J.spaceV)),o>n.peak&&(n.peak=o,n.hold=30,n.accel=0),Z.fillStyle=re[v].gradient,b?Z.fillRect(n.posX+J.spaceH/2,Q.height,j,-o):Z.fillRect(n.posX,Q.height,j,-o),n.peak>0&&(F&&(b?Z.fillRect(n.posX+J.spaceH/2,(J.nLeds-Math.floor(n.peak/Q.height*J.nLeds))*(J.ledHeight+J.spaceV),j,J.ledHeight):Z.fillRect(n.posX,Q.height-n.peak,j,2)),n.hold?n.hold--:(n.accel++,n.peak-=n.accel)),b&&(Z.fillStyle="#000",Z.fillRect(n.posX-J.spaceH/2,0,J.spaceH,Q.height))}if(b)for(Z.fillStyle="#000",m.value>1&&Z.fillRect(Q.width-J.spaceH/2,0,J.spaceH,Q.height),t=J.ledHeight;t<Q.height;t+=J.ledHeight+J.spaceV)Z.fillRect(0,t,Q.width,J.spaceV);_&&ye(),te.timer>0&&(r=Q.width/28,l=r,i=Q.width-r,s=Q.width/2,c=1.4*r,d=Q.height-3*r,u=Q.height-1.6*r,g=Q.width-6.6*r,y=Q.width/3-r,te.timer>te.fade?(Z.fillStyle="#fff",Z.strokeStyle=Z.shadowColor="#000"):(Z.fillStyle="rgba( 255, 255, 255, "+te.timer/te.fade+")",Z.strokeStyle=Z.shadowColor="rgba( 0, 0, 0, "+te.timer/te.fade+")"),Z.font="bold "+.7*r+"px sans-serif",Z.textAlign="center","all"!=te.msg&&"song"!=te.msg?Pe(te.msg,s,c):("all"==te.msg&&(Pe("Gradient: "+re[E.value].name,s,c,y),Pe("Auto gradient is "+("1"==L.dataset.active?"ON":"OFF"),s,1.8*c),Z.textAlign="left",Pe(m[m.selectedIndex].text,l,c,y),Z.textAlign="right",Pe("Repeat is "+("1"==M.dataset.active?"ON":"OFF"),i,c,y)),$[h].duration&&(Z.textAlign="right",Pe($[h].dataset.codec,i,d),Pe(Math.floor($[h].currentTime/60)+":"+("0"+Math.floor($[h].currentTime%60)).slice(-2)+" / "+Math.floor($[h].duration/60)+":"+("0"+Math.floor($[h].duration%60)).slice(-2),i,u)),Z.textAlign="left",Pe($[h].dataset.artist.toUpperCase(),l,d,g),Z.font="bold "+r+"px sans-serif",Pe($[h].dataset.title,l,u,g)),--te.timer||_e()),$[h].duration-$[h].currentTime<.05&&(p<f.children.length-1||"1"==M.dataset.active?Te(!0):Oe(0)),requestAnimationFrame(Fe)}function He(e,t){var a=document.getElementById("console");t&&(e='<span class="error"><i class="icons8-warn"></i> '+e+"</span>",document.getElementById("show_console").className="warning"),a.innerHTML+=e+"<br>",a.scrollTop=a.scrollHeight}function Ae(){"mic"==(P=B.value)?"object"==typeof Y?(Ke()&&$[h].pause(),Y.connect(V)):navigator.mediaDevices.getUserMedia({audio:!0,video:!1}).then(function(e){Y=G.createMediaStreamSource(e),He("Audio source set to microphone"),Ae()}).catch(function(e){He("Could not change audio source",!0),B.selectedIndex=0,P="player"}):("object"==typeof Y&&Y.disconnect(V),He("Audio source set to built-in player"))}function Re(e){le[e]&&(le[e].hasOwnProperty("mode")&&(m.value=le[e].mode),le[e].hasOwnProperty("fftSize")&&(y.value=le[e].fftSize),le[e].hasOwnProperty("freqMin")&&(v.value=le[e].freqMin),le[e].hasOwnProperty("freqMax")&&(b.value=le[e].freqMax),le[e].hasOwnProperty("smoothing")&&(S.value=le[e].smoothing),le[e].hasOwnProperty("showScale")&&(w.dataset.active=Number(le[e].showScale)),le[e].hasOwnProperty("highSens")&&(I.dataset.active=Number(le[e].highSens)),le[e].hasOwnProperty("showPeaks")&&(k.dataset.active=Number(le[e].showPeaks)),le[e].hasOwnProperty("blackBg")&&(O.dataset.active=Number(le[e].blackBg)),le[e].hasOwnProperty("cycleGrad")&&(L.dataset.active=Number(le[e].cycleGrad)),le[e].hasOwnProperty("ledDisplay")&&(N.dataset.active=Number(le[e].ledDisplay)),le[e].hasOwnProperty("repeat")&&(M.dataset.active=Number(le[e].repeat)),le[e].hasOwnProperty("showSong")&&(C.dataset.active=Number(le[e].showSong)),le[e].hasOwnProperty("noShadow")&&(T.dataset.active=Number(le[e].noShadow)),le[e].hasOwnProperty("loRes")&&(K.dataset.active=Number(le[e].loRes)),Ve(),le[e].hasOwnProperty("gradient")&&re[le[e].gradient]&&(E.value=le[e].gradient),ue(),de(),ce(),he(),ge())}function qe(e){var t={fftSize:y.value,freqMin:v.value,freqMax:b.value,smoothing:V.smoothingTimeConstant,gradient:E.value,mode:m.value,showScale:"1"==w.dataset.active,highSens:"1"==I.dataset.active,showPeaks:"1"==k.dataset.active,blackBg:"1"==O.dataset.active,cycleGrad:"1"==L.dataset.active,ledDisplay:"1"==N.dataset.active,repeat:"1"==M.dataset.active,showSong:"1"==C.dataset.active,noShadow:"1"==T.dataset.active,loRes:"1"==K.dataset.active};localStorage.setItem(e,JSON.stringify(t))}function De(){qe("last-config")}function ze(){qe("custom-preset"),document.getElementById("preset").value="custom"}function je(e){ne||ie();var t=E.selectedIndex,a=m.selectedIndex;switch(e.code){case"Delete":f.querySelectorAll(".selected").forEach(e=>{e.remove()});var n=xe(f.querySelector(".current"));void 0!==n?p=n:p>f.children.length-1?p=f.children.length-1:p--,Le();break;case"Space":_e(Ke()?"Pause":"Play"),Me();break;case"ArrowLeft":case"KeyJ":_e("Previous song"),Be();break;case"ArrowUp":case"ArrowDown":case"KeyG":"ArrowUp"==e.code||"KeyG"==e.code&&e.shiftKey?E.selectedIndex=0==t?E.options.length-1:t-1:t==E.options.length-1?E.selectedIndex=0:E.selectedIndex=t+1,_e("Gradient: "+re[E.value].name);break;case"ArrowRight":case"KeyK":_e("Next song"),Te();break;case"KeyA":L.click(),_e("Auto gradient "+("1"==L.dataset.active?"ON":"OFF"));break;case"KeyB":O.click(),_e("Background "+("1"==O.dataset.active?"OFF":"ON"));break;case"KeyD":te.msg?"all"==te.msg?_e():_e("all",300):_e("song",300);break;case"KeyF":se();break;case"KeyI":C.click(),_e("Song info display "+("1"==C.dataset.active?"ON":"OFF"));break;case"KeyL":N.click(),_e("LED effect "+("1"==N.dataset.active?"ON":"OFF"));break;case"KeyM":case"KeyV":e.shiftKey?m.selectedIndex=0==a?m.options.length-1:a-1:a==m.options.length-1?m.selectedIndex=0:m.selectedIndex=a+1,pe(),_e("Mode: "+m[m.selectedIndex].text);break;case"KeyN":I.click(),_e(("1"==I.dataset.active?"HIGH":"LOW")+" sensitivity");break;case"KeyO":K.click(),_e(("1"==K.dataset.active?"LOW":"HIGH")+" Resolution");break;case"KeyP":k.click(),_e("Peaks "+("1"==k.dataset.active?"ON":"OFF"));break;case"KeyR":M.click(),_e("Playlist repeat "+("1"==M.dataset.active?"ON":"OFF"));break;case"KeyS":w.click(),_e("Scale "+("1"==w.dataset.active?"ON":"OFF"));break;case"KeyT":T.click(),_e(("1"==T.dataset.active?"Flat":"Shadowed")+" text mode");break;case"KeyU":f.length>0&&(ke(),_e("Shuffled playlist"))}}function Je(e){ne?""==$[h].src?0==f.children.length?(He("No song loaded",!0),$[h].pause()):Ne(p):"1"==C.dataset.active&&_e("song",600,180):(e.target.pause(),"player1"==e.target.id&&(ne=!0,He("Started audio elements")))}function Ge(e){He("Error loading "+e.target.src,!0)}function Ve(){if(ee=window.devicePixelRatio,"1"==K.dataset.active&&(ee/=2),Q.width=window.screen.width*ee,Q.height=window.screen.height*ee,Q.height>Q.width){var e=Q.width;Q.width=Q.height,Q.height=e}var t,a;He("Canvas size is "+Q.width+"x"+Q.height+" pixels (dPR: "+ee+")"),2==ee&&Q.height<=1080&&(ee=1),Z.lineWidth=4*ee,Z.lineJoin="round",Object.keys(re).forEach(function(e){if(t=Z.createLinearGradient(0,0,0,Q.height),re[e].hasOwnProperty("colorStops"))for(a=0;a<re[e].colorStops.length;a++)t.addColorStop(re[e].colorStops[a].stop,re[e].colorStops[a].color);else if("prism"==e)for(a=0;a<=240;a+=60)t.addColorStop(a/240,"hsl( "+a+", 100%, 50% )");else if("rainbow"==e)for(t=Z.createLinearGradient(0,0,Q.width,0),a=0;a<=360;a+=60)t.addColorStop(a/360,"hsl( "+a+", 100%, 50% )");E.options.length<Object.keys(re).length&&(E.options[E.options.length]=new Option(re[e].name,e)),re[e].gradient=t}),me(),De()}!function(){He("audioMotion.js version "+ae),He("Initializing..."),(f=document.getElementById("playlist")).addEventListener("click",function(e){if(e.target){var t=e.target.className;e.ctrlKey||f.querySelectorAll(".selected").forEach(e=>e.className=e.className.replace("selected","")),-1==t.indexOf("selected")?e.target.className=t+" selected":e.target.className=t.replace("selected","")}}),f.addEventListener("dblclick",function(e){e.target&&e.target.dataset.file&&Ne(xe(e.target))}),p=0,document.getElementById("panel_selector").addEventListener("click",function(e){document.querySelectorAll("#panel_selector li").forEach(e=>{e.className="",document.getElementById(e.dataset.panel).style.display="none"}),document.getElementById(e.target.dataset.panel||e.target.parentElement.dataset.panel).style.display="block","LI"==e.target.nodeName?e.target.className="active":e.target.parentElement.className="active"}),document.getElementById("show_filelist").click();var e=window.AudioContext||window.webkitAudioContext;try{G=new e}catch(e){return He("Could not create audio context. Web Audio API not supported?",!0),He("Aborting.",!0),!1}He("Audio context sample rate is "+G.sampleRate+"Hz"),$=[document.getElementById("player0"),document.getElementById("player1")],h=0,g=1,$[0].style.display="block",$[1].style.display="none",$[0].addEventListener("play",Je),$[1].addEventListener("play",Je),$[0].addEventListener("error",Ge),$[1].addEventListener("error",Ge),V=G.createAnalyser(),(W=[G.createMediaElementSource($[0]),G.createMediaElementSource($[1])])[0].connect(V),W[1].connect(V),V.connect(G.destination),y=document.getElementById("fft_size"),v=document.getElementById("freq_min"),b=document.getElementById("freq_max"),S=document.getElementById("smoothing"),m=document.getElementById("mode"),E=document.getElementById("gradient"),w=document.getElementById("show_scale"),I=document.getElementById("sensitivity"),k=document.getElementById("show_peaks"),O=document.getElementById("black_bg"),L=document.getElementById("cycle_grad"),N=document.getElementById("led_display"),M=document.getElementById("repeat"),C=document.getElementById("show_song"),T=document.getElementById("no_shadow"),K=document.getElementById("lo_res"),B=document.getElementById("source"),x=document.getElementById("playlists");var t,a=document.querySelectorAll(".switch");for(let e=0;e<a.length;e++)a[e].addEventListener("click",function(e){e.target.className.match(/switch/)?e.target.dataset.active=Number(!Number(e.target.dataset.active)):e.target.parentElement.dataset.active=Number(!Number(e.target.parentElement.dataset.active))});w.addEventListener("click",pe),I.addEventListener("click",ce),k.addEventListener("click",he),O.addEventListener("click",ge),L.addEventListener("click",De),N.addEventListener("click",pe),M.addEventListener("click",De),C.addEventListener("click",De),T.addEventListener("click",De),K.addEventListener("click",Ve),m.addEventListener("change",pe),y.addEventListener("change",ue),v.addEventListener("change",fe),b.addEventListener("change",fe),E.addEventListener("change",De),B.addEventListener("change",Ae),S.addEventListener("change",de),document.getElementById("preset").addEventListener("change",e=>Re(e.target.value)),document.getElementById("btn_save").addEventListener("click",ze),document.getElementById("btn_prev").addEventListener("click",Be),document.getElementById("btn_play").addEventListener("click",Me),document.getElementById("btn_stop").addEventListener("click",Ce),document.getElementById("btn_next").addEventListener("click",Te),document.getElementById("btn_shuf").addEventListener("click",ke),document.getElementById("btn_fullscreen").addEventListener("click",se),document.getElementById("load_playlist").addEventListener("click",()=>Ee(x.value)),document.getElementById("save_playlist").addEventListener("click",()=>(function(e){0==f.children.length?alert("Playlist is empty!"):""==x[e].value?we():x[e].dataset.isLocal?confirm(`Overwrite "${x[e].innerText}" with current playlist contents?`)&&we(x[e].value):alert('This is a server playlist which cannot be overwritten.\n\nChoose "Save as" to create a new local playlist.')})(x.selectedIndex)),document.getElementById("create_playlist").addEventListener("click",we),document.getElementById("delete_playlist").addEventListener("click",()=>(function(e){if(confirm(`Do you really want to DELETE the "${x[e].innerText}" playlist?\n\nTHIS CANNOT BE UNDONE!`)){var t=x[e].value,a=localStorage.getItem("playlists");a&&(delete(a=JSON.parse(a))[t],localStorage.setItem("playlists",JSON.stringify(a))),localStorage.removeItem(`pl_${t}`),be()}})(x.selectedIndex)),document.getElementById("btn_clear").addEventListener("click",ve),Q=document.getElementById("canvas"),Z=Q.getContext("2d"),_e(),Q.addEventListener("click",function(){w.click()}),t=localStorage.getItem("last-config"),le.last=null!==t?JSON.parse(t):JSON.parse(JSON.stringify(le.default)),t=localStorage.getItem("custom-preset"),le.custom=null!==t?JSON.parse(t):JSON.parse(JSON.stringify(le.last)),Re("last"),Ae(),be(),u(document.getElementById("file_explorer"),{defaultPath:"/music"}).then(function(e){1==e?He("Running in standard web server mode."):-1==e&&(He("No server found. Running in local mode only.",!0),document.getElementById("local_file_panel").style.display="block",document.getElementById("local_file").addEventListener("change",e=>(function(e){var t=new FileReader;t.onload=function(){$[h].src=t.result,$[h].dataset.artist="",$[h].dataset.title="",$[h].dataset.codec="",$[h].play()},t.readAsDataURL(e.files[0])})(e.target))),document.getElementById("btn_add_folder").addEventListener("click",function(){var e;(e=[],o.childNodes.forEach(t=>{let a=t.dataset.type;"file"!=a&&"list"!=a||e.push({file:c(t.dataset.path),type:a})}),e).forEach(e=>{"file"==e.type?Se({file:e.file,common:{}}):"list"==e.type&&Ee(e.file)})})}),window.addEventListener("keyup",je),window.addEventListener("click",ie),requestAnimationFrame(Fe)}()}]);